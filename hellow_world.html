<!DOCTYPE html>
<html>

<head>
    <title>Hello World, AngularJS - ViralPatel.net</title>
    <link rel="shortcut icon" type="image/png" href="js/jasmine-2.3.4/jasmine_favicon.png">
    <link rel="stylesheet" type="text/css" href="js/jasmine-2.3.4/jasmine.css">
    <script type="text/javascript" src="js/jasmine-2.3.4/jasmine.js"></script>
    <script type="text/javascript" src="js/jasmine-2.3.4/jasmine-html.js"></script>
    <script type="text/javascript" src="js/jasmine-2.3.4/boot.js"></script>
    <script src="js/angular.min.js"></script>
    <script src="https://code.angularjs.org/1.2.9/angular-mocks.js"></script>
</head>

<body ng-app="myApp">
    <div ng-controller="ccc as f">
          <div>
            <input type="text"  ng-model="password">
        </div>
        <div>
            <input type="number" min="0" ng-model="f.qty">
        </div>
        <div>
            <input type="number" min="0" ng-model="f.cost">
        </div>
        <select ng-model="f.inCurr">
            <option ng-repeat="c in f.currencies">{{c}}</option>
        </select>
        <div>
            <b>Total:</b>
            <span ng-repeat="d in f.currencies">
      {{f.total(d)|currency:d}}
    </span>
            <button class="btn" ng-click="f.pay()">Pay</button>
        </div>
    </div>
    <script type="text/javascript">
    var app = angular.module('myApp', ['m2']); //讀取另一個module的檔案

    //  app.controller(name,['factory1','factory2','factory3....',function(fn1,fn2,fn3...)
    //


    app.controller('ccc', ['converter', '$scope', function(currencyConverter, $scope) {

        this.qty = 1;

        this.cost = 2;
        this.inCurr = 'EUR';
        this.currencies = ['USD', 'EUR', 'CNY'];
        this.usdToForeignRates = {
            USD: 1,
            EUR: 0.74,
            CNY: 6.09
        };
        this.currencies = currencyConverter.currencies;



        this.total = function total(outCurr) {
            return currencyConverter.convert(this.qty * this.cost, this.inCurr, outCurr);
        }



        this.pay = function pay() {
            window.alert("Thanks!!");
        }

    }]).controller('ddd', function($scope) {
        return "Hello World"
    });


    app.controller('PasswordController', function PasswordController($scope) {
        $scope.password = '';
        $scope.grade = function() {
            var size = $scope.password.length;
            if (size > 8) {
                $scope.strength = 'strong';
            } else if (size > 3) {
                $scope.strength = 'medium';
            } else {
                $scope.strength = 'weak';
            }
        };
    });



    // factory 製作可輸出的module
    var app2 = angular.module('m2', []).factory('converter', ['$http', function($http) {

        //$http  angular ajax

        var currencies = ['USD', 'EUR', 'CNY'];
        var YAHOO_FINANCE_URL_PATTERN =
            '//query.yahooapis.com/v1/public/yql?q=select * from ' +
            'yahoo.finance.xchange where pair in ("PAIRS")&format=json&' +
            'env=store://datatables.org/alltableswithkeys&callback=JSON_CALLBACK';


        var usdToForeignRates = {};

        var convert = function(amount, inCurr, outCurr) {
            return amount * usdToForeignRates[outCurr] / usdToForeignRates[inCurr];
        };

        var refresh = function() {
            var url = YAHOO_FINANCE_URL_PATTERN.
            replace('PAIRS', 'USD' + currencies.join('","USD'));
            return $http.jsonp(url).success(function(data) { // angular jsonp

                var newUsdToForeignRates = {};
                angular.forEach(data.query.results.rate, function(rate) { //angular foreach
                    var currency = rate.id.substring(3, 6);
                    newUsdToForeignRates[currency] = window.parseFloat(rate.Rate);
                });
                usdToForeignRates = newUsdToForeignRates;
            });
        };

        refresh();

        return {
            currencies: currencies,
            convert: convert,
            refresh: refresh
        };
    }])


    //單元測試
    /*

    describe('PasswordController', function() {
        beforeEach(module('myApp'));

        var $controller;

        beforeEach(inject(function(_$controller_) {
            // The injector unwraps the underscores (_) from around the parameter names when matching
            $controller = _$controller_;
        }));

        describe('$scope.grade', function() {
            it('sets the strength to "strong" if the password length is >8 chars', function() {
                var $scope = {};
                var controller = $controller('PasswordController', {
                    $scope: $scope
                });
                $scope.password = 'q5466464465465456w';
                $scope.grade();
                expect($scope.strength).toEqual('strong');
            });
        });
    });*/
    </script>
</body>

</html>
