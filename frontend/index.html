<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>army list</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
    <script src="https://code.angularjs.org/1.2.9/angular-mocks.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/default.css">
</head>

<body ng-app="myApp">
    <div class="container-fluid row" ng-controller="main" id="wrap">
        <div class="row">
            <div class="col-xs-4 " id="choice_product">
                <div class="row">
                    <div class="col-xs-12">
                        <select ng-model="series.default_value" ng-change="seriesSelect()" ng-options="sel.title for sel in series.data track by sel._id">
                            <option value="">--</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <select ng-model="faction.default_value" ng-options="sel.title for sel in faction.data track by sel._id">
                            <option value="">--</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <select ng-model="category.default_value" ng-options="sel.title for sel in category.data track by sel._id">
                            <option value="">--</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-8">
                        <input type="text" ng-model="keyword">
                    </div>
                    <div class="col-xs-4">
                        <button ng-click="search()">search</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-6">
                        <button ng-click="dataDisplayBtn.changeType('imgList')" ng-disabled="dataDisplayBtn.displayBtn.imgList">img list</button>
                    </div>
                    <div class="col-xs-6">
                        <button ng-click="dataDisplayBtn.changeType('dataList')" ng-disabled="dataDisplayBtn.displayBtn.dataList">data list</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-6">
                        <button ng-click="itemSelect.selectTrigger()" ng-disabled="itemSelect.selectDisable">{{itemSelect.selectText}}</button>
                    </div>
                    <div class="col-xs-6">
                    </div>
                </div>
            </div>
            <div class="col-xs-8">
            </div>
        </div>
        <div class="row">
            <ul id="product_list" class="col-xs-6 row" product-list>
            </ul>
            <ul id="selected_list" class="col-xs-6 row" selected-list>
            </ul>
        </div>
        <div ng-click="testa()">bbbbbbbbb</div>
    </div>
    <script>
    var app = angular.module('myApp', []);

    app.controller('main', function($scope, $http, $sce) {

        var pageshow = 10;
        var currentPage = 0;

        $scope.returnArmy = [];

        $scope.$watch("returnArmy", function(_new) {
            if (_new.length > 0) {
                $scope.itemSelect.selectDisable = false;
            }
        })



        $scope.itemSelect = {
            selectMode: false,
            selectDisable: true,
            selectClass: "",
            selectText: "select",
            selected: [],
            selectedArmy: [],
            selectTrigger: function() {
                if (this.selectMode == false) {
                    this.selectMode = true;
                    this.selectClass = "selectOn";
                    this.selectText = "cancel";
                } else {
                    this.selectMode = false;
                    this.selectClass = "";
                    this.selectText = "select";
                }
            },
            combineSelectToreturnArmy: function() {

                for (var i = 0; i < $scope.returnArmy.length; i++) {
                    //init value
                    $scope.returnArmy[i].hasSelect = '';
                    $scope.returnArmy[i].icon = '';
                    for (var j = 0; j < this.selected.length; j++) {
                        if ($scope.returnArmy[i]._id == this.selected[j]) {

                            $scope.returnArmy[i].hasSelect = 'hasSelected';
                            $scope.returnArmy[i].icon = 'fa-check-circle-o';
                            break;
                        }

                    }

                    if (typeof($scope.returnArmy[i].hasSelect) == '') {
                        $scope.returnArmy[i].hasSelect = '';
                        $scope.returnArmy[i].icon = 'fa-circle-o';
                    }
                }
            }
        };

        $scope.dataDisplayBtn = {
            displayType: 0, //0:img , 1:data
            displayBtn: {
                imgList: true,
                dataList: false
            },

            changeType: function(_current) {

                switch (_current) {
                    case "imgList":

                        $scope.itemDisplay = {
                            row: "col-xs-4",
                            img: "col-xs-12",
                            title: "col-xs-12"
                        }

                        break;

                    case "dataList":
                        $scope.itemDisplay = {
                            row: "col-xs-12",
                            img: "col-xs-4",
                            title: "col-xs-8"
                        }
                        break;
                }

                for (var _key in this.displayBtn) {
                    if (_current == _key) {
                        this.displayBtn[_key] = true;
                    } else {
                        this.displayBtn[_key] = false;
                    }
                }

            }
        };


        $scope.itemDisplay = {
            row: "col-xs-4",
            img: "col-xs-12",
            title: "col-xs-12"
        }


        /*
                $scope.checkIcon = {
                    hasChecked: $sce.trustAsHtml("<i class='fa fa-check-circle-o fa-2x'></i>"),
                    nonChecked: $sce.trustAsHtml("<i class='fa fa-circle-o fa-2x'></i>")
                }
        */

        $scope.search = function() {

            var _series_id = ($scope.series.default_value == null) ? null : $scope.series.default_value._id;
            var _faction_id = ($scope.faction.default_value == null) ? null : $scope.faction.default_value._id;
            var _category_id = ($scope.category.default_value == null) ? null : $scope.category.default_value._id;
            var _keyword = ($scope.keyword == "undefined") ? null : $scope.keyword;
            //var _keyword= ''
            $http.post("getData", {
                type: "search",
                series: _series_id,
                faction: _faction_id,
                category: _category_id,
                keyword: _keyword,
                pageshow: pageshow,
                currentPage: currentPage
            }).then(function(response) {
                $scope.returnArmy = response.data;
                $scope.itemSelect.combineSelectToreturnArmy();

            })

        }


        /*
                $scope.changePoint = function(score) {
                    console.log(score);
                }*/

        $http.post("getData", {
            type: "series"
        }).success(function(response) {
            $scope.series = {
                data: response,
                default_value: null
            }

            $scope.faction = {
                data: null,
                default_value: null
            }


            $scope.category = {
                data: null,
                default_value: null
            }

            $scope.seriesSelect = function() {

                if ($scope.series.default_value != null) {

                    $http.post("getData", {
                        type: "faction",
                        id: $scope.series.default_value._id
                    }).success(function(response) {
                        $scope.faction = {
                            data: response,
                            default_value: null
                        }
                    })

                    $http.post("getData", {
                        type: "category",
                        id: $scope.series.default_value._id
                    }).success(function(response) {
                        $scope.category = {
                            data: response,
                            default_value: null
                        }
                    })
                }
            }



        });


    })

    app.directive('itemSelect', function($compile) {
        return {
            restrict: 'A',
            link: function(scope, element, attrs) {

                var _r = angular.element(element[0].getElementsByClassName('imgArea'));

                _r.bind('click', function() {

                    if (!scope.itemSelect.selectMode) {
                        return false
                    };

                    var _i = this.find('i');
                    if (!this.hasClass('hasSelected')) {

                        if (scope.itemSelect.selected.indexOf(element.attr('_id')) == -1) {
                            scope.itemSelect.selected.push(element.attr('_id'));

                            for (var i = 0; i < scope.returnArmy.length; i++) {
                                if (scope.returnArmy[i]._id == element.attr('_id')) {
                                    scope.itemSelect.selectedArmy.push(scope.returnArmy[i]);
                                }
                            }

                        }

                    } else {

                        scope.itemSelect.selected.splice(scope.itemSelect.selected.indexOf(element.attr('_id')), 1);

                        for (var i = 0; i < scope.itemSelect.selectedArmy.length; i++) {

                            if (scope.itemSelect.selectedArmy[i]._id == element.attr('_id')) {
                                scope.itemSelect.selectedArmy.splice(i, 1);
                            }
                        }


                    }

                    scope.itemSelect.combineSelectToreturnArmy();
                    scope.$apply()

                }.bind(_r))


            }
        }
    })

    app.directive('imageonload', function($compile) {
        return {
            restrict: 'A',
            link: function(scope, element, attrs) {
                element.bind('error', function() {
                    console.log("err");
                    var html = '<div class="no_img">I should not be red</div>';
                    var e = $compile(html)(scope);
                    element.replaceWith(e);
                });
            }
        };
    });

    app.directive('productList', ["$compile", "dataTemplates", function($compile, dataTemplates) {
        return {
            restrict: 'A',
            templateUrl: dataTemplates.imgList
        }
    }])

    app.directive('selectedList', ["$compile", "dataTemplates", function($compile, dataTemplates) {
        return {
            restrict: 'A',
            templateUrl: dataTemplates.selectedList
        }
    }])


    app.factory('dataTemplates', function() {
        return {
            imgList: "template/item_list.html",
            selectedList: "template/selected_list.html"
        }
    })
    </script>
</body>

</html>
